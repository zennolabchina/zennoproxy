<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1,IE=edge"/>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="robots" content="noindex,nofollow">
    <link href="../layui/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/xadmin-while.css">
    <script src="../layui/layui.js"></script>
	<script src="../modules/xm-select.js"></script>
</head>
<style>
	.layui-form-item{margin-bottom: 25px!important;}
	xm-select .xm-label .xm-label-block{z-index: 4;}
	.layui-links,.layui-links:hover{color: #01aaed;}	
</style>
<body>
<form class="layui-form" action="" style="padding-top: 15px;">
<div class="layui-fluid port_dialog">
	<div class="layui-form-item">
		<label for="auth">Authentic</label>
		<input type="text" name="auth" class="layui-input">
	</div>
	<div class="layui-form-item">
		<label for="Source">Source</label>
		<div id="Source" class="xm-select-demo"></div>
	</div>
	<div class="layui-row layui-col-space5">
		<div class="layui-col-xs4">
			<div class="layui-form-item">
				<label for="country">Country</label>
				<div id="Country" class="xm-select-demo"></div>
			</div>
		</div>		
		<div class="layui-col-xs4">
			<div class="layui-form-item">
				<label for="State">State</label>
				<div id="State" class="xm-select-demo"></div>
			</div>
		</div>
		<div class="layui-col-xs4">
			<div class="layui-form-item">
				<label for="City">City</label>
				<div id="City" class="xm-select-demo"></div>
			</div>
		</div>
	</div>
	<div class="layui-form-item">
		<label for="Zone">Zone</label>
		<div id="Zone" class="xm-select-demo"></div>
	</div>
	<div class="layui-form-item">
		<label for="whitelist">Whitelist</label>
		<div id="whitelist" class="xm-select-demo"></div>
	</div>
	<div class="layui-form-item">
		<label for="noproxylist">ByPassList</label>
		<div id="noproxylist" class="xm-select-demo"></div>
	</div>
	<div class="layui-form-item">
		<label for="proxy_platform">StickyTime</label>
		<div id="StickyTime" class="xm-select-demo"></div>
	</div>
</div>
</form>	
<script>
layui.extend({
	common: '../modules/common'
});
layui.use(['form','common'], function(){
	var $ = layui.jquery
		,form = layui.form
		,common = layui.common;
		
	
	var urlParams = new URLSearchParams(window.location.search);
	var jsonDataString = urlParams.get('data');	
	
	var jsonData = JSON.parse(decodeURIComponent(jsonDataString));	
	var globalSource = "";
	var globalCountry = "";
	
	var server = common.get_server_ip();
	var user;
	user = JSON.parse(localStorage.getItem("user"));
	if(user == null){
		window.location.href='../login.html';  
	}
	
	var select_source = xmSelect.render({
		el: "#Source",
		language: 'en',
		name: "platform",
		tips: 'Please select',
		filterable: true, 
		filterMethod: function(val, item, index, prop){
			var value = val.toLowerCase();
			if(value == item.value){
				return true;
			}
			if(item.name.indexOf(value) != -1){
				return true;
			}
			return false;
		},
		radio:true,
		clickClose:true,
		data: [],
		on: function(data){
			select_country.update({
				data: [],
				disabled:true
			})
			select_state.update({
				data: [],
				disabled:true
			})
			select_city.update({
				data: [],
				disabled:true
			})
			select_StickyTime.update({
				data: [],
				disabled:true
			})			
			var change = data.change;
			var item = change[0];
			if(data.isAdd){
				globalSource = item.value;
				var country_url = server + "sv5-proxy/get_proxy_area/" + item.value;
				var sticky_url = server + "sv5-proxy/get_proxy_sticky/" + item.value;
				var request_country = $.ajax({
					url: country_url,
					method: "GET"
				});			
				var request_sticky = $.ajax({
					url: sticky_url,
					method: "GET"
				});
				$.when(request_country, request_sticky).done(function(res1, res2) {
					var data_country = res1[0];
					common.setXmSelectInit(select_country,data_country.data,'');
					var data_sticky = res2[0];
					common.setXmSelectInit(select_StickyTime,data_sticky,'',"min");
				});
			}
		}
	})
	var select_country = xmSelect.render({
		el: "#Country",
		language: 'en',
		name: "country",
		tips: 'Please select',
		filterable: true,
		filterMethod: function(val, item, index, prop){
			var value = val.toLowerCase();
			if(value == item.value){
				return true;
			}
			if(item.name.indexOf(value) != -1){
				return true;
			}
			return false;
		},
		radio:true,
		clickClose:true,
		disabled: true,
		data: [],
		on: function(data){
			select_state.update({
				data: [],
				disabled:true
			})
			select_city.update({
				data: [],
				disabled:true
			})
			var change = data.change;
			var item = change[0];
			if(data.isAdd){
				globalCountry = item.value;
				var state_url = server + "sv5-proxy/get_proxy_area/" + globalSource + "?country=" + item.value;
				common.getAjaxData(state_url,"GET",function(res) {
					common.setXmSelect(select_state,res.data);
				});	
			}
		}
	})
	var select_state = xmSelect.render({
		el: "#State",
		language: 'en',
		name: "state",
		tips: 'Please select',
		filterable: true,
		filterMethod: function(val, item, index, prop){
			var value = val.toLowerCase();
			if(value == item.value){
				return true;
			}
			if(item.name.indexOf(value) != -1){
				return true;
			}
			return false;
		},
		radio:true,
		clickClose:true,
		disabled: true,
		data: [],
		on: function(data){
			select_city.update({
				data: [],
				disabled:true
			})
			var change = data.change;
			var item = change[0];
			if(data.isAdd){
				var city_url = server + "sv5-proxy/get_proxy_area/" + globalSource + "?country=" + globalCountry + "&state=" + item.value;
				common.getAjaxData(city_url,"GET",function(res) {
					common.setXmSelect(select_city,res.data);
				});	
			}
			
		}
	})
	var select_city = xmSelect.render({
		el: "#City",
		language: 'en',
		name: "city",
		tips: 'Please select',
		filterable: true,
		filterMethod: function(val, item, index, prop){
			var value = val.toLowerCase();
			if(value == item.value){
				return true;
			}
			if(item.name.indexOf(value) != -1){
				return true;
			}
			return false;
		},
		radio:true,
		clickClose:true,
		disabled: true,
		data: []
	})
	var select_zone = common.xmSelectInitialize("#Zone","zone",true,true,false,false);
	var select_whitelist = common.xmSelectInitialize("#whitelist","whitelist",true,false,true,false);
	var select_noproxylist = common.xmSelectInitialize("#noproxylist","noproxylist",true,false,true,false);
	var select_StickyTime = common.xmSelectInitialize("#StickyTime","sticky",true,true,false,true);
	
	var source_url = server + "sv5-flow/get_user_proxy_platform/" + user.user_id;
	common.getAjaxData(source_url,"GET",function(res) {
		common.setXmSelect(select_source,res.data);		
	});
	
	if(jsonData != null){
		if(jsonData['auth'] != ""){
			$('[name="auth"]').val(jsonData['auth']);
			form.render();
		}
		if(jsonData['platform'] != ""){
			globalSource = jsonData['platform'];
			
			var proxy_area_url = server + "sv5-proxy/get_proxy_area/" + jsonData['platform'];
			var proxy_area = [];
			if(jsonData['area']!= ""){
				proxy_area = jsonData['area'].split("-");
			}
			var str_country ='';
			var str_state =''; 
			var str_city =''; 
			if (typeof proxy_area[0] !== 'undefined') {
				str_country = proxy_area[0];
				globalCountry = str_country;
				proxy_area_url = proxy_area_url + "?country=" + str_country; 
			}else{
				proxy_area_url = proxy_area_url + "?country=''"; 
			}
			if (typeof proxy_area[1] !== 'undefined') {
				str_state = proxy_area[1];
				proxy_area_url = proxy_area_url + "&state=" + str_state; 		
			}else{
				proxy_area_url = proxy_area_url + "&state=''"; 
			}
			if (typeof proxy_area[2] !== 'undefined') {
				str_city =  proxy_area[2];
				proxy_area_url = proxy_area_url + "&city=" + str_city;
			}else{
				proxy_area_url = proxy_area_url + "&city=''"; 
			}
			
			common.getAjaxData( proxy_area_url,"GET",function(res) {
				if(globalSource != undefined){		
					common.setXmSelectInit(select_source,res.data.platform_list,globalSource);
				}
				if(str_country != undefined){
					common.setXmSelectInit(select_country,res.data.country_list,str_country);
				}
				if(str_state != undefined){ 
					common.setXmSelectInit(select_state,res.data.state_list,str_state);
				}
				if(str_city != undefined){
					common.setXmSelectInit(select_city,res.data.city_list,str_city);
				}
			});
			
			var sticky_url = server + "sv5-proxy/get_proxy_sticky/" + globalSource;
			common.getAjaxData( sticky_url,"GET",function(res){
				var proxy_sticky = "";
				if(jsonData['sticky'] != ""){
					proxy_sticky = String(jsonData['sticky']);
				}
				common.setXmSelectInit(select_StickyTime,res,proxy_sticky,"min");
			});
		}
	}
	
	var zwb_url = server + "sv5-server/get_zone_whitelist_noproxylist/" + user.user_id;
	common.getAjaxData(zwb_url,"GET",function(res) {
		var arr_zone = [];
		$.each(res.data.zone, function(index, object) {
			var obj_zone = {
				name: String(object.zone),
				value: object.zone
			};
			arr_zone.push(obj_zone);
		});
		if(jsonData != null){
			var zone_initValue = jsonData['zone'].split(",");
			select_zone.update({
				disabled: false,
				data: arr_zone,
				initValue: zone_initValue
			})
		}else{
			select_zone.update({
				disabled: false,
				data: arr_zone
			})
		}
		
		var arr_whitelist = [];
		$.each(res.data.whitelist, function(index, object) {
			var obj_whitelist = {
				name: String(object.whitelist),
				value: object.whitelist
			};
			arr_whitelist.push(obj_whitelist);
		});
		if(jsonData != null){
			var whitelist_initValue = jsonData['whitelist'].split(",");
			select_whitelist.update({
				disabled: false,
				data: arr_whitelist,
				initValue: whitelist_initValue
			})
		}else{
			select_whitelist.update({
				disabled: false,
				data: arr_whitelist
			})
		}
		
		var arr_noproxylist = [];
		$.each(res.data.noproxylist, function(index, object) {
			var obj_noproxylist = {
				name: String(object.noproxylist),
				value: object.noproxylist
			};
			arr_noproxylist.push(obj_noproxylist);
		});
		if(jsonData != null){
			var noproxylist_initValue = jsonData['noproxylist'].split(",");
			select_noproxylist.update({
				disabled: false,
				data: arr_noproxylist,
				initValue: noproxylist_initValue
			})
		}else{
			select_noproxylist.update({
				disabled: false,
				data: arr_noproxylist
			})
		}
	});
	
	$(".port_dialog .layui-form-item input").focus(function(){
	    $(this).parents('.layui-form-item').addClass("layui-input-focus");
	})	
	$(".port_dialog .layui-form-item input").blur(function(){
	    $(this).parents('.layui-form-item').removeClass("layui-input-focus");
	})
});
</script>
</body>
</html>