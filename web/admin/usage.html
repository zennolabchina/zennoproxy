<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1,IE=edge"/>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="robots" content="noindex,nofollow">
    <link href="../layui/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/xadmin-while.css">
    <script src="../layui/layui.js"></script>
</head>
<style>
	 body{padding: 0; margin: 0;}
	 .layui-table-view{border: none;}
	 .layui-fluid{padding-top: 10px;}
	 .layui-fluid .layui-form{padding-bottom: 10px;}
</style>
<body>
<div class="x-nav">
	<span class="layui-breadcrumb">
		<a><cite>Homepage</cite></a> 
		<a><cite>Standby Package</cite></a>
	</span>
	<a class="layui-btn layui-btn-xs" onclick="location.reload()" title="Refresh">
		<i class="layui-icon layui-icon-refresh-3"></i>
	</a>
</div>
<div class="layui-fluid">
	<div class="layui-row">
		<div class="table">
			<form class="layui-form" action="">
				<div class="layui-inline">
					<div class="layui-input-inline">
						<div class="layui-input-wrap">
							<div class="layui-input-prefix">
								<i class="layui-icon layui-icon-username"></i>
							</div>
							<input type="text" name="user_name" placeholder="Please enter User Name" class="layui-input">
						</div>
					</div>
				</div>
				<div class="layui-inline">
					<div class="layui-input-inline">
						<div class="layui-input-wrap">
							<div class="layui-input-prefix">
								<i class="layui-icon layui-icon-template-1"></i>
							</div>
							<input type="text" name="device_name" placeholder="Please enter Device Name" class="layui-input">
						</div>
					</div>
				</div>
				<div class="layui-inline">
					<div class="layui-input-inline">
						<div class="layui-input-wrap">
							<div class="layui-input-prefix">
								<i class="layui-icon layui-icon-component"></i>
							</div>
							<input type="text" name="platform_name" placeholder="Please enter Platform Name" class="layui-input">
						</div>
					</div>
				</div>
				<div class="layui-inline">					
					<div class="layui-input-inline">
						<div class="layui-input-wrap">
							<div class="layui-input-prefix">
								<i class="layui-icon layui-icon-form"></i>
							</div>
							<select name="state">
								<option value="">Please select State</option>
								<option value="0">StandBy</option>
								<option value="1">Used</option>
								<option value="2">Expired</option>
								<option value="3">Deactivate</option>
							</select>
						</div>						
					</div>
				</div>
				<div class="layui-inline">
					<div class="layui-btn-group">
						<button type="submit" class="layui-btn layui-btn-sm" lay-submit lay-filter="search"><i class="layui-icon layui-icon-search"></i> Search</button>
						<button type="button" class="layui-btn layui-btn-sm layui-bg-orange" id="Reset"><i class="layui-icon layui-icon-refresh-3"></i> Reset</button>
						<button type="button" class="layui-btn layui-btn-sm layui-bg-blue" onclick="add()"><i class="layui-icon layui-icon-engine"></i> Allocated Traffic</button>
					</div>
				</div>
				
			</form>
			<table id="users" lay-filter="users"></table>
		</div>
	</div>
</div>
<script type="text/html" id="barActions">
	<div class="layui-btn-group">
		<button type="button" lay-event="edit" class="layui-btn layui-btn-xs layui-bg-blue"><i class="layui-icon layui-icon-edit"></i>Edit</button>
	</div>
</script>
<script type="text/html" id="total">
	{{ formatNumber(d.total,2) }}
</script>
<script type="text/html" id="usage">
	{{#  var pro = ((d.used / d.total) * 100).toFixed(2); }}
	<div class="layui-progress layui-progress-big" lay-showpercent="true">
	  <div class="layui-progress-bar" lay-percent="{{= pro }}%"></div>
	</div>
</script>
<script type="text/html" id="state">
	{{#  if(d.state == 0){ }}
	StandBy
	{{#  }else if(d.state == 1){ }}
	Used
	{{#  }else if(d.state == 2){ }}
	Expired
	{{#  }else if(d.state == 3){ }}
	Deactivate
	{{#  } }}
</script>
<script>
layui.extend({
	common: '../modules/common'
});
layui.use(['table','form','element','common'], function(){
	var $ = layui.jquery
		,table = layui.table
		,form = layui.form
		,element = layui.element
		,common = layui.common;
	
	var user;
	user = JSON.parse(localStorage.getItem("admin"));
	if(user == null){
		window.location.href='../login.html';  
	}
	var server = 'http://' + user.device_ip + ':12569/';
	
	var users_url = server + "sv5-flow-standby/get_page/" + user.user_id;
	var user_manage = table.render({
		elem: '#users'
		,height: 'full-140'
		,url: users_url
		,page: {
			layout: ['prev', 'page', 'next', 'skip', 'count','limit'],
		}
		,limit:50
		,limits:[50,100,200]
		,skin:'nob'
		,text: {none: 'No Data'}
		,request: {
		  pageName: 'page_index',
		  limitName: 'page_size'
		}
		,cols: [[
			{field: 'actions', title: 'Actions',width:260,align:'center', toolbar: '#barActions'}
			,{field: 'user_name', title: 'User Name',align:'center'}
			,{field: 'total', title: 'Allocated Traffic',align:'center', templet: '#total'}
			,{field: 'usage', title: 'Usage',align:'center', templet: '#usage'}
			,{field: 'device_name', title: 'Device Name',align:'center'}
			,{field: 'platform_name', title: 'Platform Name',align:'center'}
			,{field: 'state', title: 'State',align:'center', templet: '#state'}
			,{field: 'active_plan', title: 'Active Plan',align:'center'}
		]],
		done: function(res, curr, count, origin){
		    element.render();
		},
		error: function(res){
			var errorText = 'Data loading failed!';	
			if (res.status === 404) {
				errorText = 'The data interface does not exist!';
			} else if (res.status === 500) {
				errorText = 'Server error!';
			}
			$('.layui-table-main .layui-none').text(errorText);
		},
		parseData: function(res){
			return {
				"code": 0,
				"msg": res.message,
				"count": res.data.recordCount,
				"data": res.data.data
			};
		}
	});
		
	window.formatNumber = function(num, n) {
	    const units = ["B", "KB", "MB", "GB", "TB"];
	    let unitIndex = 0;
	    while (num >= 1000 && unitIndex < units.length) {
	        num /= 1000;
	        unitIndex++;
	    }
	    const roundedNum = num.toFixed(n);
	    return `${roundedNum}${units[unitIndex]}`;
	}
	
	window.add = function(){
		var post_url = server + "sv5-flow-standby/add";
		var index_allocate = parent.layer.open({
			type: 2,
			title: ["Allocated Traffic", 'font-size:14px;font-weight:bold'],
			area: ["620px","550px"],
			content: "./allocate_add.html",
			btn: ['Confirm','Cannel'],
			btnAlign: 'l',
			btn1: function (index_layer, layero) {					
				var formData = parent.layer.getChildFrame('body', index_layer).contents().serializeArray();
				var jsonObject = {};
				$.each(formData, function() {
				   if (jsonObject[this.name]) {
				      if (!jsonObject[this.name].push) {
				         jsonObject[this.name] = [jsonObject[this.name]];
				      }
				      jsonObject[this.name].push(this.value || '');
				   } else {
				      jsonObject[this.name] = this.value || '';
				   }
				});
				jsonObject["platform"] = "mihuan-ox";
				common.doAjaxTableReload(post_url,"POST","users",1,jsonObject);
			},
		});
	}
	
	table.on('tool(users)', function(obj){
		var data = obj.data;
		if(obj.event === 'edit'){
			var jsonString = JSON.stringify(data);
			var url = './allocate_edit.html?data=' + encodeURIComponent(jsonString);
			var post_url = server + "sv5-flow-standby/update";
			var index_allocate = parent.layer.open({
				type: 2,
				title: ["Edit Allocated Traffic", 'font-size:14px;font-weight:bold'],
				area: ["520px","520px"],
				content: url,
				btn: ['Confirm','Cannel'],
				btnAlign: 'l',
				btn1: function (index_layer, layero) {
					var formData = parent.layer.getChildFrame('body', index_layer).contents().serializeArray(); 
					var jsonObject = {};
					$.each(formData, function() {
					   if (jsonObject[this.name]) {
					      if (!jsonObject[this.name].push) {
					         jsonObject[this.name] = [jsonObject[this.name]];
					      }
					      jsonObject[this.name].push(this.value || '');
					   } else {
					      jsonObject[this.name] = this.value || '';
					   }
					});
					jsonObject["id"] = data.id;
					common.doAjaxTableReload(post_url,"PATCH","users",1,jsonObject);
				},
			});
		}
	});
	
	form.on('submit(search)', function(data){
		var field = data.field;
		var url = users_url + "?user_name=" + field.user_name + "&device_name=" + field.device_name + "&platform_name=" + field.platform_name + "&state=" + field.state;
		table.reload('users', {
			url:url
		});
		return false;
	});
	
	$('#Reset').on('click', function(){
		location.reload();
		return false;
	});
	
	// form.on('select', function(data){
	// 	var url;
	// 	if(data.value == ''){
	// 		url = server + "sv5-flow-standby/get_page/" + user.user_id;
	// 	}else{
	// 		url = server + "sv5-flow-standby/get_page/" + user.user_id + "?state=" + data.value;
	// 	}
	// 	table.reload('users', {
	// 		url:url
	// 	});
	// });
	
});
</script>
</body>
</html>